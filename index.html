<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ã‚ºãƒ«</title>
<style>
body{margin:0;font-family:sans-serif;background:#f4f6f9;text-align:center;}
button{
  padding:15px 0;
  font-size:24px;
  width:60%;
  margin:10px auto;
  display:block;
  border:none;
  border-radius:10px;
  background:#4a90e2;
  color:white;
  cursor:pointer;
}
button:hover{background:#357ae8;}
#sizeSelect{
  width:60%;
  font-size:24px;
  padding:10px;
  margin:10px auto 20px auto;
  display:block;
  border-radius:10px;
  border:1px solid #ccc;
  text-align:center;
}
#board{display:grid;margin:10px auto;gap:4px;}
.tile{aspect-ratio:1/1;background:linear-gradient(145deg,#6fb1fc,#4364f7);
color:white;font-weight:bold;display:flex;justify-content:center;align-items:center;border-radius:10px;}
.empty{background:transparent;}
.podium{display:flex;justify-content:center;align-items:flex-end;gap:10px;margin:10px 0;}
.podiumItem{width:95px;padding:8px;border-radius:12px 12px 0 0;color:white;font-weight:bold;}
.first{height:130px;background:gold;}
.second{height:95px;background:silver;}
.third{height:75px;background:#b87333;}
.highlight{box-shadow:0 0 15px 5px #00ffcc;}
#stats{margin-top:20px;background:white;padding:10px;border-radius:12px;max-width:400px;margin-left:auto;margin-right:auto;}
.screen{display:none;}
</style>
</head>
<body>

<!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
<div id="homeScreen" class="screen" style="display:block;">
<h1>ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ã‚ºãƒ«</h1>
<button onclick="showScreen('sizeScreen')">ãƒ—ãƒ¬ã‚¤</button>
<button onclick="showScreen('detailScreen')">è©³ç´°</button>
</div>

<!-- ã‚µã‚¤ã‚ºé¸æŠç”»é¢ -->
<div id="sizeScreen" class="screen">
<h1>ã‚µã‚¤ã‚ºã‚’é¸ã‚“ã§ãã ã•ã„</h1>
<select id="sizeSelect">
<option value="3">3Ã—3</option>
<option value="4" selected>4Ã—4</option>
<option value="5">5Ã—5</option>
<option value="6">6Ã—6</option>
<option value="7">7Ã—7</option>
<option value="8">8Ã—8</option>
<option value="9">9Ã—9</option>
<option value="10">10Ã—10</option>
</select>
<br>
<button onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
<br>
<button onclick="showScreen('homeScreen')">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
</div>

<!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
<div id="gameScreen" class="screen">
<h1>ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‘ã‚ºãƒ«</h1>
<div id="moveCount">æ‰‹æ•°:0</div>
<div id="newRecord"></div>
<div id="board"></div>
<h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
<div id="ranking"></div>
<button onclick="showScreen('sizeScreen')">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
</div>

<!-- è©³ç´°ç”»é¢ -->
<div id="detailScreen" class="screen">
<h1>è©³ç´°</h1>
<button onclick="showDetail('stats')">çµ±è¨ˆ</button>
<button onclick="showDetail('ranking')">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
<div id="detailContent"></div>
<br>
<button onclick="showScreen('homeScreen')">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
</div>

<script>
let size=4, board=[], emptyIndex, moveCount=0;

// ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='block';
}

// è©³ç´°ç”»é¢ã®å†…å®¹åˆ‡æ›¿
function showDetail(type){
  const content=document.getElementById('detailContent');
  content.innerHTML='';
  if(type==='stats'){
    const s=JSON.parse(localStorage.getItem("stats"))||{};
    let avg=s.totalClear?Math.floor(s.totalMoves/s.totalClear):0;
    content.innerHTML=
      `ç·ãƒ—ãƒ¬ã‚¤: ${s.play||0}<br>
       ç·ã‚¯ãƒªã‚¢: ${s.clear||0}<br>
       ãƒ™ã‚¹ãƒˆæ›´æ–°: ${s.update||0}<br>
       å¹³å‡æ‰‹æ•°: ${avg}`;
  } else if(type==='ranking'){
    const key="ranking_"+size;
    let data=JSON.parse(localStorage.getItem(key))||[];
    if(data.length===0){content.innerText="ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“"; return;}
    const podium=document.createElement("div");
    podium.className="podium";
    [1,0,2].forEach(i=>{
      if(!data[i])return;
      const d=document.createElement("div");
      d.className="podiumItem "+(i===0?"first":i===1?"second":"third");
      d.innerHTML=`${["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i]}<br>${data[i].name}<br>${data[i].moves}`;
      podium.appendChild(d);
    });
    content.appendChild(podium);
  }
}

// ã‚²ãƒ¼ãƒ é–‹å§‹
function startGame(){
  size=parseInt(document.getElementById('sizeSelect').value);
  board=[];
  for(let i=1;i<size*size;i++)board.push(i);
  board.push(null);
  emptyIndex=board.length-1;

  for(let i=0;i<size*size*20;i++){
    let moves=getMoves(emptyIndex);
    let r=moves[Math.floor(Math.random()*moves.length)];
    [board[emptyIndex],board[r]]=[board[r],board[emptyIndex]];
    emptyIndex=r;
  }

  moveCount=0;
  moveCountDisplay();
  render();
  showScreen('gameScreen');
  updateStats("play");
  loadRanking();
}

// ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆã‚¿ã‚¤ãƒ«ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦æ•°å­—ã‚’æ‹¡å¤§ï¼‰
function render(){
  const boardEl=document.getElementById("board");
  boardEl.innerHTML="";
  boardEl.style.gridTemplateColumns=`repeat(${size},1fr)`;
  const maxSize=Math.min(innerWidth*0.9,innerHeight*0.6);
  boardEl.style.width=maxSize+"px";
  boardEl.style.height=maxSize+"px";

  const tileSize = maxSize / size;       // ã‚¿ã‚¤ãƒ«1ã¤ã®ã‚µã‚¤ã‚º
  const fontSize = tileSize * 0.5;       // ã‚¿ã‚¤ãƒ«ã‚µã‚¤ã‚ºã«å¿œã˜ãŸæ–‡å­—ã‚µã‚¤ã‚ºï¼ˆèª¿æ•´å¯ï¼‰

  board.forEach((n,i)=>{
    const d=document.createElement("div");
    d.className="tile";
    d.style.fontSize = fontSize + "px"; // å‹•çš„ã«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºè¨­å®š
    if(n===null) d.classList.add("empty");
    else {
      d.textContent=n;
      d.onclick=()=>move(i);
    }
    boardEl.appendChild(d);
  });
}

// ç§»å‹•
function move(i){
  if(getMoves(emptyIndex).includes(i)){
    [board[emptyIndex],board[i]]=[board[i],board[emptyIndex]];
    emptyIndex=i;
    moveCount++;
    moveCountDisplay();
    render();
    if(clearCheck())setTimeout(clearGame,100);
  }
}

// ç§»å‹•å¯èƒ½
function getMoves(i){
  const arr=[];
  const r=Math.floor(i/size);
  const c=i%size;
  if(r>0)arr.push(i-size);
  if(r<size-1)arr.push(i+size);
  if(c>0)arr.push(i-1);
  if(c<size-1)arr.push(i+1);
  return arr;
}

// æ‰‹æ•°è¡¨ç¤º
function moveCountDisplay(){
  document.getElementById("moveCount").innerText="æ‰‹æ•°:"+moveCount;
}

// ã‚¯ãƒªã‚¢åˆ¤å®š
function clearCheck(){
  for(let i=0;i<board.length-1;i++)if(board[i]!==i+1)return false;
  return true;
}

// ã‚¯ãƒªã‚¢å‡¦ç†
function clearGame(){
  let name=prompt("ã‚¯ãƒªã‚¢ï¼åå‰ã‚’å…¥åŠ›");
  if(name===null)return;
  saveScore(name||"åç„¡ã—");
  alert("ã‚¯ãƒªã‚¢ï¼æ‰‹æ•°: "+moveCount+"å›");
  render();
}

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜
function saveScore(name){
  const key="ranking_"+size;
  let data=JSON.parse(localStorage.getItem(key))||[];
  data.push({name,moves:moveCount});
  data.sort((a,b)=>a.moves-b.moves);
  let newBest=data[0].moves===moveCount;
  data=data.slice(0,5);
  localStorage.setItem(key,JSON.stringify(data));
  if(newBest)document.getElementById("newRecord").innerText="ğŸ‰ NEW RECORD!";
  else document.getElementById("newRecord").innerText="";
  loadRanking(moveCount);
}

// ã‚²ãƒ¼ãƒ ç”»é¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
function loadRanking(latest=null){
  const key="ranking_"+size;
  let data=JSON.parse(localStorage.getItem(key))||[];
  const r=document.getElementById("ranking");
  r.innerHTML="";
  if(data.length===0)return;
  const podium=document.createElement("div");
  podium.className="podium";
  [1,0,2].forEach(i=>{
    if(!data[i])return;
    const d=document.createElement("div");
    d.className="podiumItem "+(i===0?"first":i===1?"second":"third");
    d.innerHTML=`${["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i]}<br>${data[i].name}<br>${data[i].moves}`;
    if(latest===data[i].moves)d.classList.add("highlight");
    podium.appendChild(d);
  });
  r.appendChild(podium);
}

// çµ±è¨ˆ
function updateStats(type){
  let s=JSON.parse(localStorage.getItem("stats"))||{play:0,clear:0,update:0,totalMoves:0,totalClear:0};
  if(type==="play")s.play++;
  if(type==="clear"){s.clear++;s.totalMoves+=moveCount;s.totalClear++;}
  if(type==="update")s.update++;
  localStorage.setItem("stats",JSON.stringify(s));
}

showScreen('homeScreen');
</script>

</body>
</html>
