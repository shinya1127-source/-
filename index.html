<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>„Çπ„É©„Ç§„Éâ„Éë„Ç∫„É´</title>
<style>
body{margin:0;font-family:sans-serif;background:#f4f6f9;text-align:center;}
button{
  padding:15px 0;
  font-size:24px;
  width:60%;
  margin:10px auto;
  display:block;
  border:none;
  border-radius:10px;
  background:#4a90e2;
  color:white;
  cursor:pointer;
}
button:hover{background:#357ae8;}
#sizeSelect{
  width:60%;
  font-size:24px;
  padding:10px;
  margin:10px auto 20px auto;
  display:block;
  border-radius:10px;
  border:1px solid #ccc;
  text-align:center;
}
#board{display:grid;margin:10px auto;gap:4px;}
.tile{
  aspect-ratio:1/1;
  background:linear-gradient(145deg,#6fb1fc,#4364f7);
  color:white;font-weight:bold;
  display:flex;justify-content:center;align-items:center;
  border-radius:10px;
  transition: transform 0.2s;
  user-select:none;
}
.empty{background:transparent;}
.podium{display:flex;justify-content:center;align-items:flex-end;gap:10px;margin:10px 0;}
.podiumItem{width:95px;padding:8px;border-radius:12px 12px 0 0;color:white;font-weight:bold;}
.first{height:130px;background:gold;}
.second{height:95px;background:silver;}
.third{height:75px;background:#b87333;}
.highlight{box-shadow:0 0 15px 5px #00ffcc;}
#stats{margin-top:20px;background:white;padding:10px;border-radius:12px;max-width:400px;margin-left:auto;margin-right:auto;}
.screen{display:none;}
table{border-collapse:collapse;}
td{border:1px solid #ccc;text-align:center;}
</style>
</head>
<body>

<!-- „Éõ„Éº„É†ÁîªÈù¢ -->
<div id="homeScreen" class="screen" style="display:block;">
<h1>„Çπ„É©„Ç§„Éâ„Éë„Ç∫„É´</h1>
<button onclick="showScreen('sizeScreen')">„Éó„É¨„Ç§</button>
<button onclick="showScreen('detailScreen')">Ë©≥Á¥∞</button>
</div>

<!-- „Çµ„Ç§„Ç∫ÈÅ∏ÊäûÁîªÈù¢ -->
<div id="sizeScreen" class="screen">
<h1>„Çµ„Ç§„Ç∫„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</h1>
<select id="sizeSelect">
<option value="3">3√ó3</option>
<option value="4" selected>4√ó4</option>
<option value="5">5√ó5</option>
<option value="6">6√ó6</option>
<option value="7">7√ó7</option>
<option value="8">8√ó8</option>
<option value="9">9√ó9</option>
<option value="10">10√ó10</option>
</select>
<br>
<button onclick="startGame()">„Çπ„Çø„Éº„Éà</button>
<br>
<button onclick="showScreen('homeScreen')">„Éõ„Éº„É†„Å´Êàª„Çã</button>
</div>

<!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
<div id="gameScreen" class="screen">
<h1>„Çπ„É©„Ç§„Éâ„Éë„Ç∫„É´</h1>
<div id="moveCount">ÊâãÊï∞:0</div>
<div id="newRecord"></div>
<div id="board"></div>
<h3>üèÜ „É©„É≥„Ç≠„É≥„Ç∞</h3>
<div id="ranking"></div>
<button onclick="showScreen('sizeScreen')">„Éõ„Éº„É†„Å´Êàª„Çã</button>
</div>

<!-- Ë©≥Á¥∞ÁîªÈù¢ -->
<div id="detailScreen" class="screen">
<h1>Ë©≥Á¥∞</h1>
<button onclick="showDetail('stats')">Áµ±Ë®à</button>
<button onclick="showDetail('ranking')">„É©„É≥„Ç≠„É≥„Ç∞</button>
<div id="detailContent"></div>
<br>
<button onclick="showScreen('homeScreen')">„Éõ„Éº„É†„Å´Êàª„Çã</button>
</div>

<script>
let size=4, board=[], emptyIndex, moveCount=0;

// ÁîªÈù¢Âàá„ÇäÊõø„Åà
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='block';
}

// Ë©≥Á¥∞ÁîªÈù¢
function showDetail(type){
  const content=document.getElementById('detailContent');
  content.innerHTML='';
  if(type==='stats'){
    const s=JSON.parse(localStorage.getItem("stats"))||{};
    let avg=s.totalClear?Math.floor(s.totalMoves/s.totalClear):0;
    content.innerHTML=
      `Á∑è„Éó„É¨„Ç§: ${s.play||0}<br>
       Á∑è„ÇØ„É™„Ç¢: ${s.clear||0}<br>
       „Éô„Çπ„ÉàÊõ¥Êñ∞: ${s.update||0}<br>
       Âπ≥ÂùáÊâãÊï∞: ${avg}`;
  } else if(type==='ranking'){
    // „Çµ„Ç§„Ç∫ÈÅ∏Êäû
    const sizeSelect = document.createElement("select");
    for(let sz=3; sz<=10; sz++){
      const opt = document.createElement("option");
      opt.value = sz;
      opt.text = sz+"√ó"+sz;
      if(sz===size) opt.selected=true;
      sizeSelect.appendChild(opt);
    }
    sizeSelect.onchange = () => displayRanking(parseInt(sizeSelect.value));
    content.appendChild(sizeSelect);

    // „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫„É©„ÉÉ„Éë„Éº
    const rankingWrapper = document.createElement("div");
    rankingWrapper.id="rankingListWrapper";
    rankingWrapper.style.marginTop="10px";
    rankingWrapper.style.overflowX="auto";
    rankingWrapper.style.maxWidth="100%";
    content.appendChild(rankingWrapper);

    displayRanking(size);

    function displayRanking(selSize){
      const key="ranking_"+selSize;
      let data=JSON.parse(localStorage.getItem(key))||[];
      data.sort((a,b)=>a.moves-b.moves);
      const r=document.getElementById("rankingListWrapper");
      r.innerHTML="";
      if(data.length===0){ r.innerText="„É©„É≥„Ç≠„É≥„Ç∞„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì"; return; }
      const table=document.createElement("table");
      table.style.margin="0 auto";
      table.style.minWidth="300px";
      data.forEach((d,i)=>{
        const row=document.createElement("tr");
        const rankCell=document.createElement("td");
        rankCell.innerText=i+1;
        rankCell.style.padding="4px 8px";
        rankCell.style.fontWeight="bold";
        const nameCell=document.createElement("td");
        nameCell.innerText=d.name;
        nameCell.style.padding="4px 8px";
        const movesCell=document.createElement("td");
        movesCell.innerText=d.moves;
        movesCell.style.padding="4px 8px";
        row.appendChild(rankCell);
        row.appendChild(nameCell);
        row.appendChild(movesCell);
        table.appendChild(row);
      });
      r.appendChild(table);
    }
  }
}

// „Ç≤„Éº„É†ÈñãÂßã
function startGame(){
  size=parseInt(document.getElementById('sizeSelect').value);
  board=[];
  for(let i=1;i<size*size;i++) board.push(i);
  board.push(null);
  emptyIndex=board.length-1;

  for(let i=0;i<size*size*20;i++){
    let moves=getMoves(emptyIndex);
    let r=moves[Math.floor(Math.random()*moves.length)];
    [board[emptyIndex],board[r]]=[board[r],board[emptyIndex]];
    emptyIndex=r;
  }

  moveCount=0;
  moveCountDisplay();
  render();
  showScreen('gameScreen');
  updateStats("play");
  loadRanking();
}

// „É¨„É≥„ÉÄ„É™„É≥„Ç∞
function render(){
  const boardEl=document.getElementById("board");
  boardEl.innerHTML="";
  boardEl.style.gridTemplateColumns=`repeat(${size},1fr)`;
  const maxSize=Math.min(innerWidth*0.9,innerHeight*0.6);
  boardEl.style.width=maxSize+"px";
  boardEl.style.height=maxSize+"px";

  const tileSize = maxSize/size;
  const fontSize = tileSize * 0.6; // „Çø„Ç§„É´„Å´ÊúÄÂ§ßÈôê„Éï„Ç£„ÉÉ„Éà

  board.forEach((n,i)=>{
    const d=document.createElement("div");
    d.className="tile";
    if(n===null) d.classList.add("empty");
    else{
      d.textContent=n;
      d.style.fontSize=fontSize+"px";
      d.onclick=()=>move(i);
    }
    boardEl.appendChild(d);
  });
}

// ÁßªÂãï
function move(i){
  if(getMoves(emptyIndex).includes(i)){
    [board[emptyIndex],board[i]]=[board[i],board[emptyIndex]];
    emptyIndex=i;
    moveCount++;
    moveCountDisplay();
    render();
    if(clearCheck()) setTimeout(clearGame,100);
  }
}

// ÁßªÂãïÂèØËÉΩ
function getMoves(i){
  const arr=[];
  const r=Math.floor(i/size);
  const c=i%size;
  if(r>0) arr.push(i-size);
  if(r<size-1) arr.push(i+size);
  if(c>0) arr.push(i-1);
  if(c<size-1) arr.push(i+1);
  return arr;
}

// ÊâãÊï∞Ë°®Á§∫
function moveCountDisplay(){
  document.getElementById("moveCount").innerText="ÊâãÊï∞:"+moveCount;
}

// „ÇØ„É™„Ç¢Âà§ÂÆö
function clearCheck(){
  for(let i=0;i<board.length-1;i++) if(board[i]!==i+1) return false;
  return true;
}

// „ÇØ„É™„Ç¢Âá¶ÁêÜ
function clearGame(){
  let name=prompt("„ÇØ„É™„Ç¢ÔºÅÂêçÂâç„ÇíÂÖ•Âäõ");
  if(name===null) return;
  saveScore(name||"ÂêçÁÑ°„Åó");
  updateStats("clear");
  alert("„ÇØ„É™„Ç¢ÔºÅÊâãÊï∞: "+moveCount+"Âõû");
  render();
}

// „É©„É≥„Ç≠„É≥„Ç∞‰øùÂ≠ò
function saveScore(name){
  const key="ranking_"+size;
  let data=JSON.parse(localStorage.getItem(key))||[];
  data.push({name,moves:moveCount});
  data.sort((a,b)=>a.moves-b.moves);
  let newBest = data[0].moves===moveCount;
  data=data.slice(0,50); // ‰∏ä‰Ωç50‰ª∂‰øùÊåÅ
  localStorage.setItem(key,JSON.stringify(data));
  if(newBest) document.getElementById("newRecord").innerText="üéâ NEW RECORD!";
  else document.getElementById("newRecord").innerText="";
  loadRanking(moveCount);
}

// „Ç≤„Éº„É†ÁîªÈù¢„É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫
function loadRanking(latest=null){
  const key="ranking_"+size;
  let data=JSON.parse(localStorage.getItem(key))||[];
  const r=document.getElementById("ranking");
  r.innerHTML="";
  if(data.length===0) return;
  const table=document.createElement("table");
  table.style.margin="0 auto";
  table.style.minWidth="300px";
  data.sort((a,b)=>a.moves-b.moves);
  data.forEach((d,i)=>{
    const row=document.createElement("tr");
    const rankCell=document.createElement("td");
    rankCell.innerText=i+1;
    rankCell.style.padding="4px 8px";
    rankCell.style.fontWeight="bold";
    const nameCell=document.createElement("td");
    nameCell.innerText=d.name;
    nameCell.style.padding="4px 8px";
    const movesCell=document.createElement("td");
    movesCell.innerText=d.moves;
    movesCell.style.padding="4px 8px";
    if(latest===d.moves) row.style.background="#d4f7e2"; // ÊúÄÊñ∞„Çπ„Ç≥„Ç¢„Éè„Ç§„É©„Ç§„Éà
    row.appendChild(rankCell);
    row.appendChild(nameCell);
    row.appendChild(movesCell);
    table.appendChild(row);
  });
  r.appendChild(table);
}

// Áµ±Ë®à
function updateStats(type){
  let s=JSON.parse(localStorage.getItem("stats"))||{play:0,clear:0,update:0,totalMoves:0,totalClear:0};
  if(type==="play") s.play++;
  if(type==="clear"){ s.clear++; s.totalMoves+=moveCount; s.totalClear++; }
  if(type==="update") s.update++;
  localStorage.setItem("stats",JSON.stringify(s));
}

showScreen('homeScreen');
</script>

</body>
</html>
